# Lego Studio 渲染系统详解

本文档详细介绍了 Lego Studio 的核心渲染原理与技术实现。该系统基于现代 OpenGL (Core Profile 3.3+) 构建，实现了阴影映射、实时环境反射、物理材质属性以及电影级色调映射。

## 1. 渲染管线概览 (Rendering Pipeline)

每一帧的渲染过程 (`Renderer.render`) 被严格划分为四个阶段，以确保光影关系的正确性：

1.  **阴影贴图生成 (Shadow Pass)**: 从光源视角渲染场景深度。
2.  **环境贴图生成 (Environment Pass)**: 为反射材质生成实时 Cubemap。
3.  **主场景渲染 (Main Pass)**: 应用光照、材质、阴影和反射。
4.  **辅助元素渲染 (Overlay Pass)**: 绘制网格、光源指示器、选中轮廓等。

---

## 2. 核心技术原理

### 2.1 阴影映射 (Shadow Mapping)

为了产生真实的阴影，系统采用了标准的双通道阴影映射技术。

*   **实现原理**:
    1.  **光空间变换**: 构建一个正交投影矩阵 (`light_projection`) 和视图矩阵 (`light_view`)，模拟平行光（太阳光）的视角。
    2.  **深度渲染**: 在第一遍渲染中，使用 `shadow_prog` 着色器，仅输出片元的深度值到 2048x2048 的帧缓冲对象 (FBO) 中。
    3.  **阴影计算**: 在主着色器中，将当前片元坐标变换到光空间，比较其深度与 Shadow Map 中的记录值。

*   **优化技术**:
    *   **PCF (Percentage-Closer Filtering)**: 3x3 采样核心，对阴影边缘进行平滑处理，消除锯齿，产生软阴影效果。
    *   **自适应偏差 (Adaptive Bias)**: `max(0.002 * (1.0 - dot(normal, lightDir)), 0.0002)`。根据表面法线与光线的夹角动态调整偏差值，有效解决了“阴影痤疮” (Shadow Acne) 和“彼得潘悬浮” (Peter Panning) 问题。

### 2.2 实时环境映射 (Real-time Environment Mapping)

为了实现类似镀铬或光面塑料的反射效果，系统生成了动态的环境贴图。

*   **实现原理**:
    *   **Cubemap FBO**: 创建一个包含 6 个面的纹理附件的帧缓冲。
    *   **6面渲染**: 在 `render` 过程中，摄像机被放置在场景中心 (0,0,0)，依次向 +X, -X, +Y, -Y, +Z, -Z 六个方向渲染场景。
    *   **反射采样**: 在主片元着色器中，计算视线在法线上的反射向量 `reflect(-view_dir, norm)`，并用此向量采样 Cubemap。

### 2.3 材质系统 (Material System)

系统支持基于物理的材质属性模拟，通过 Uniforms 传递给着色器：

*   **Shininess (光泽度)**: 控制高光点的聚焦程度（值越高，高光越小越锐利）。
*   **Specular Strength (高光强度)**: 控制高光的亮度。
*   **Reflectivity (反射率)**: 控制环境反射与物体本色的混合比例。
*   **Metallic (金属度)**:
    *   **非金属 (Plastic)**: 漫反射为本色，高光为白色。
    *   **金属 (Metal)**: 漫反射趋向黑色，高光带物体本色。
*   **Rim Lighting (边缘光)**: 模拟菲涅尔轮廓光，增强物体的体积感和轮廓清晰度。

### 2.4 光照模型 (Lighting Model)

片元着色器采用了改进的 **Blinn-Phong** 模型，结合了物理渲染 (PBR) 的部分思想：

```glsl
// 最终颜色构成
FinalColor = Ambient + (Diffuse + Specular) * (1.0 - Shadow) + Rim + Reflection
```

*   **菲涅尔效应 (Fresnel Effect)**: 实现了 Schlick 近似。当视线与物体表面平行时（掠射角），反射会变得更强。
    ```glsl
    float fresnel = 0.04 + (1.0 - 0.04) * pow(1.0 - clamp(dot(norm, view_dir), 0.0, 1.0), 5.0);
    ```

### 2.5 后处理 (Post-Processing)

为了获得电影级的视觉效果，我们在着色器末端应用了颜色校正：

*   **ACES Tone Mapping**: 学院色彩编码系统 (Academy Color Encoding System)。将高动态范围 (HDR) 的光照值映射到 [0, 1] 显示范围，保留高光细节并增强对比度，避免颜色过曝。
*   **Gamma 校正**: 将线性空间的颜色转换为 sRGB 空间 (Gamma 2.2)，以匹配显示器的非线性输出。

---

## 3. 辅助功能实现

### 3.1 无限网格与坐标轴
*   **网格**: 使用 `GL_LINES` 绘制，通过 Shader 统一着色。
*   **防闪烁 (Z-fighting Fix)**: 坐标轴 (RGB线) 的 Y 轴坐标被微调了 +0.5，使其物理上悬浮于网格之上，彻底消除了重叠时的闪烁现象。

### 3.2 光源可视化 (Light Gizmo)
*   **透视显示**: 在绘制光源方块时，暂时禁用了深度测试 (`glDisable(gl.GL_DEPTH_TEST)`)。这使得光源指示器能够透过墙壁和物体被看到，方便用户定位。
*   **矩阵隔离**: 使用独立的模型矩阵变量，防止 Python 垃圾回收导致的指针悬空问题。

### 3.3 选中轮廓 (Selection Outline)
*   **多边形偏移 (Polygon Offset)**: 绘制轮廓时，使用 `glPolygonOffset(-1.0, -1.0)` 将线框在深度值上向摄像机拉近，确保轮廓线不会被物体本身遮挡。

## 4. 文件结构

*   `src/renderer.py`: 渲染核心类，包含所有 OpenGL 调用、Shader 代码和渲染循环。
*   `src/scene.py`: 场景图管理，负责计算物体的世界变换矩阵。
*   `src/main.py`: 主程序入口，处理窗口事件和 ImGui 界面交互。
